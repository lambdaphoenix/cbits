name: üêç Build Wheels & Publish Python Package
on:
    push:
        tags:
            - 'v*.*.*'

permissions:
    contents: write

jobs:
    build:
        runs-on: ${{ matrix.os }}
        strategy:
            matrix:
                os: [ubuntu-latest, macos-latest, windows-latest]
        env:
            CIBW_OUTPUT_DIR: dist
            CIBW_SKIP: ""
            CIBW_BUILD: "cp37-* cp38-* cp39-* cp310-* cp311-* cp312-* cp313-*"
        steps:
            - name: Check out code
              uses: actions/checkout@v4

            - name: Setup Python & build tools
              uses: actions/setup-python@v5
              with:
                python-version: "3.x"

            - name: Install build dependencies
              run: |
                python -m pip install --upgrade pip build cibuildwheel[global]

            - name: Build wheels
              run: |
                python -m cibuildwheel

            - name: Build source‚Äêdist
              run: |
                python -m build --sdist --outdir dist

            - name: Upload all artifacts
              uses: actions/upload-artifact@v3
              with:
                path: dist
    
    release:
        name: Attach & Publish
        needs: build
        runs-on: ubuntu-latest
        env:
            TWINE_USERNAME: __token__
            TWINE_PASSWORD: ${{ secrets.PYPI_TOKEN }}
        
        steps:
            - name: Download built wheels & sdist
              uses: actions/download-artifact@v3
              with:
                path: dist

            - name: Create GitHub Release assets
              uses: softprops/action-gh-release@v1
              with:
                tag_name: ${{ github.ref_name }}
                files: dist/*

            - name: Publish to PyPI
              if: env.TWINE_PASSWORD != ''
              uses: pypa/gh-action-pypi-publish@v1
              with:
                user: ${{ env.TWINE_USERNAME }}
                password: ${{ env.TWINE_PASSWORD }}
